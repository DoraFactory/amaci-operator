# Benchmark Cost Calculation

This directory contains benchmark data and automated cost calculation reports for the AMACI operator.

## Files

- **`cost.json`**: Configuration file containing base costs for different machine types and scales
- **`report.json`**: Auto-generated JSON report with detailed cost calculations (generated by CI/CD)
- **`report.md`**: Auto-generated human-readable Markdown report (generated by CI/CD)
- **`bench-12c-128G-Bare-metal.md`**: Manual benchmark results for 12c-128G bare metal configuration

## Automated Cost Calculation

The cost calculation is automatically triggered by:

1. **On Commit**: When `benchmark/cost.json` is modified and pushed/PR'd
2. **Daily Schedule**: Every day at 00:00 Beijing Time (16:00 UTC)
3. **Manual Trigger**: Can be manually triggered via GitHub Actions workflow

### How It Works

The calculation script (`scripts/calculate-benchmark.ts`):

1. Reads cost configuration from `cost.json`
2. Fetches current DORA price from CoinGecko API (ID: `dora-factory-2`)
3. Calculates costs using the formula:
   ```
   Final USD Cost = Base Cost ร Idle Sharing Multiplier
   DORA Amount = Final USD Cost รท DORA Price
   ```
4. Compares with previous report to show price changes
5. Generates both JSON and Markdown reports
6. Commits the reports back to the repository

### Cost Configuration Format

```json
{
  "machineTypes": {
    "12c-128G-Bare-metal": {
      "currentTallyCostUsd": {
        "2-1-1-5": 0.02,
        "4-2-2-25": 1
      },
      "idleSharingMultiplier": 10
    }
  }
}
```

- **currentTallyCostUsd**: Base cost in USD for each scale
- **idleSharingMultiplier**: Multiplier to account for idle machine sharing

### Running Manually

To generate a report manually:

```bash
# No need to build, tsx runs TypeScript directly
npm run benchmark:calculate
```

The generated reports will be saved to:
- `benchmark/report.json`
- `benchmark/report.md`

### Report Format

The generated report includes:

- **Timestamp**: When the report was generated
- **DORA Price**: Current price and 24h change from CoinGecko
- **Cost Breakdown**: For each machine type and scale:
  - Base cost in USD
  - Multiplier applied
  - Final cost in USD
  - Equivalent DORA amount
  - Change indicator (compared to previous report)
- **Price Comparison**: How DORA price changed since last report

### GitHub Actions Workflow

The workflow is defined in `.github/workflows/benchmark-report.yml` and:

1. Checks out the repository
2. Sets up Node.js environment
3. Installs dependencies (including `tsx` for running TypeScript)
4. Runs the cost calculation directly using `tsx`
5. Commits and pushes the reports if changed
6. On pull requests, posts the report as a comment

## Notes

- The DORA price is fetched in real-time from CoinGecko API
- If the API fails, it will retry 3 times, then fall back to cached price
- Reports are automatically committed with `[skip ci]` to avoid triggering infinite loops
- The daily scheduled run ensures reports stay up-to-date with DORA price fluctuations

